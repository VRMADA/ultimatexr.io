<!-- layouts/partials/flatten-menu.html -->
{{ $currentIndex := .index }}
{{ $accumulator := .accumulator }}

{{ if not $accumulator }}
  <!-- Initialize accumulator as a slice if it's not provided -->
  {{ $accumulator = slice }}
{{ end }}

{{ range .menu }}
  {{ if or .url (not .items) }}
    {{/* Directly append items since $accumulator is always a slice */}}
    {{ $item := dict "index" $currentIndex "title" .title "url" .url }}
    {{ $accumulator = $accumulator | append $item }}
    {{ $currentIndex = add $currentIndex 1 }}
  {{ end }}

  {{ if .items }}
    {{/* Recurse for nested items, passing the updated accumulator and current index */}}
    {{ $subresult := partial "flatten-menu.html" (dict "menu" .items "accumulator" $accumulator "index" $currentIndex) }}
    {{ $accumulator = $subresult.accumulator }}
    {{ $currentIndex = $subresult.index }}
  {{ end }}
{{ end }}

{{ return dict "accumulator" $accumulator "index" $currentIndex }}
